From 42409601328f8065738cb41df1c6369bcce85a2e Mon Sep 17 00:00:00 2001
From: Gregory Hainaut <gregory.hainaut@gmail.com>
Date: Sat, 11 Feb 2017 20:06:26 +0100
Subject: [PATCH 29/33] mesa glthread: don't set a dispatch table if we aren't
 the owner

Fix crashes when glxMakeCurrent is called.

Signed-off-by: Gregory Hainaut <gregory.hainaut@gmail.com>
---
 src/mesa/main/glthread.c | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/src/mesa/main/glthread.c b/src/mesa/main/glthread.c
index b17d9c64ca5..51c7f506cf8 100644
--- a/src/mesa/main/glthread.c
+++ b/src/mesa/main/glthread.c
@@ -175,9 +175,17 @@ _mesa_glthread_destroy(struct gl_context *ctx)
    free(glthread);
    ctx->GLThread = NULL;
 
-   /* Remove ourselves from the dispatch table. */
-   ctx->CurrentClientDispatch = ctx->CurrentServerDispatch;
-   _glapi_set_dispatch(ctx->CurrentClientDispatch);
+   /* Remove ourselves from the dispatch table except if another ctx/thread
+    * already installed a new dispatch table.
+    *
+    * Typically glxMakeCurrent will bind a new context (install new table) then
+    * old context might be deleted.
+    */
+   if (_glapi_get_dispatch() == ctx->MarshalExec) {
+       ctx->CurrentClientDispatch = ctx->CurrentServerDispatch;
+       _glapi_set_dispatch(ctx->CurrentClientDispatch);
+   }
+
 }
 
 void
-- 
2.11.1

