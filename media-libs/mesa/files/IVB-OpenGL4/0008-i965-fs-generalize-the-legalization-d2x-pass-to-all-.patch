From 7c5fad3848b5b8ffb359860f312589d57fa5f9a6 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Samuel=20Iglesias=20Gons=C3=A1lvez?= <siglesias@igalia.com>
Date: Fri, 20 Jan 2017 08:47:05 +0100
Subject: [PATCH 08/37] i965/fs: generalize the legalization d2x pass to all
 instructions
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Samuel Iglesias Gons√°lvez <siglesias@igalia.com>
---
 src/mesa/drivers/dri/i965/brw_fs_lower_d2x.cpp | 17 +++++------------
 1 file changed, 5 insertions(+), 12 deletions(-)

diff --git a/src/mesa/drivers/dri/i965/brw_fs_lower_d2x.cpp b/src/mesa/drivers/dri/i965/brw_fs_lower_d2x.cpp
index a2db1154615..cec42d54cb8 100644
--- a/src/mesa/drivers/dri/i965/brw_fs_lower_d2x.cpp
+++ b/src/mesa/drivers/dri/i965/brw_fs_lower_d2x.cpp
@@ -33,17 +33,8 @@ fs_visitor::lower_d2x()
    bool progress = false;
 
    foreach_block_and_inst_safe(block, fs_inst, inst, cfg) {
-      if (inst->opcode != BRW_OPCODE_MOV)
-         continue;
-
-      if (inst->dst.type != BRW_REGISTER_TYPE_F &&
-          inst->dst.type != BRW_REGISTER_TYPE_D &&
-          inst->dst.type != BRW_REGISTER_TYPE_UD)
-         continue;
-
-      if (inst->src[0].type != BRW_REGISTER_TYPE_DF &&
-          inst->src[0].type != BRW_REGISTER_TYPE_UQ &&
-          inst->src[0].type != BRW_REGISTER_TYPE_Q)
+      if (get_exec_type_size(inst) != 8 ||
+          type_sz(inst->dst.type) >= get_exec_type_size(inst))
          continue;
 
       assert(inst->dst.file == VGRF);
@@ -61,10 +52,12 @@ fs_visitor::lower_d2x()
        * So we need to allocate a temporary that's two registers, and then do
        * a strided MOV to get the lower DWord of every Qword that has the
        * result.
+       *
+       * This pass legalizes all the DF conversions to narrower types.
        */
       fs_reg temp = ibld.vgrf(inst->src[0].type, 1);
       fs_reg strided_temp = subscript(temp, inst->dst.type, 0);
-      ibld.MOV(strided_temp, inst->src[0]);
+      ibld.emit(inst->opcode, strided_temp, inst->src[0], inst->src[1], inst->src[2]);
       ibld.MOV(dst, strided_temp);
 
       inst->remove(block);
-- 
2.11.0

